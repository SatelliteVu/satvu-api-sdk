name: PR Checks

on:
  pull_request:
    branches:
      - main

env:
  DAGGER_NO_NAG: "1"

jobs:
  # Detect which files changed to conditionally run jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      test: ${{ steps.filter.outputs.test }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            test:
              - 'src/**'
              - 'pyproject.toml'
              - 'uv.lock'
              - 'hatch_build.py'
              - '.github/workflows/pr.yml'
              - 'dagger.json'
              - '.dagger/**'

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Ensure cache directory exists
        run: mkdir -p .cache/hypothesis-examples
      - name: Test
        uses: dagger/dagger-for-github@v8.2.0
        with:
          call: build-release

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Ensure cache directory exists
        run: mkdir -p .cache/hypothesis-examples
      - name: Test
        uses: dagger/dagger-for-github@v8.2.0
        with:
          call: lint

  test:
    name: Test (Python ${{ matrix.python-version }})
    needs: changes
    if: ${{ needs.changes.outputs.test == 'true' }}
    runs-on: ubuntu-latest-4-cores-public
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Ensure cache directory exists
        run: mkdir -p .cache/hypothesis-examples
      - name: Restore hypothesis examples cache
        uses: actions/cache/restore@v5
        with:
          path: .cache/hypothesis-examples
          key: hypothesis-examples-${{ hashFiles('src/builder/config.py') }}-${{ github.run_id }}
          restore-keys: |
            hypothesis-examples-${{ hashFiles('src/builder/config.py') }}-
            hypothesis-examples-
      - name: Run tests in dagger
        uses: dagger/dagger-for-github@v8.2.0
        with:
          call: test --python-version=${{ matrix.python-version }} --with-coverage=${{ matrix.python-version == '3.13' }} export --path=.
      - name: Save hypothesis examples cache
        uses: actions/cache/save@v5
        if: always()
        with:
          path: .cache/hypothesis-examples
          key: hypothesis-examples-${{ hashFiles('src/builder/config.py') }}-${{ github.run_id }}
      - name: Coverage comment
        if: matrix.python-version == '3.13'
        uses: MishaKav/pytest-coverage-comment@v1.1.57
        with:
          pytest-coverage-path: ./pytest-coverage.txt
          junitxml-path: ./pytest.xml

  # Summary job for required status check - handles skipped tests gracefully
  test-status:
    name: Test Status
    needs: [changes, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.changes.outputs.test }}" == "false" ]]; then
            echo "Tests skipped - no relevant files changed"
            exit 0
          elif [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "Tests passed"
            exit 0
          else
            echo "Tests failed"
            exit 1
          fi
